---
interface Props {
  headline: string;
  description: string;
  buttonText: string;
  /** What fields to collect. Defaults to email + website. */
  fields?: ('email' | 'website')[];
}

const {
  headline,
  description,
  buttonText,
  fields = ['email', 'website']
} = Astro.props;

const showWebsite = fields.includes('website');

// Web3Forms access key
const WEB3FORMS_KEY = '99a20438-b99f-4305-a261-e32934e77a2a';
---

<div class="blog-cta" id="blog-cta-container">
  <h3 class="cta-headline">{headline}</h3>
  <p class="cta-description">{description}</p>

  <form
    class="cta-form"
    id="blog-cta-form"
    action="https://api.web3forms.com/submit"
    method="POST"
  >
    <!-- Web3Forms access key -->
    <input type="hidden" name="access_key" value={WEB3FORMS_KEY} />

    <!-- Context fields -->
    <input type="hidden" name="subject" id="cta-subject" value="" />
    <input type="hidden" name="from_page" id="cta-from-page" value="" />
    <input type="hidden" name="page_url" id="cta-page-url" value="" />

    <!-- Honeypot for spam -->
    <input type="checkbox" name="botcheck" class="hidden" style="display:none" />

    <div class="cta-fields">
      <div class="form-field">
        <label for="cta-email">Email</label>
        <input
          type="email"
          id="cta-email"
          name="email"
          placeholder="you@company.com"
          required
        />
      </div>

      {showWebsite && (
        <div class="form-field">
          <label for="cta-website">Business website</label>
          <input
            type="url"
            id="cta-website"
            name="website"
            placeholder="https://yourbusiness.com"
            required
          />
        </div>
      )}
    </div>

    <button type="submit" class="cta-submit" id="cta-submit-btn">{buttonText}</button>
  </form>

  <!-- Success message (hidden by default) -->
  <div class="cta-success" id="cta-success" style="display: none;">
    <p class="success-message">Thanks! I'll take a look and get back to you soon.</p>
  </div>

  <p class="cta-fallback" id="cta-fallback">
    Or just email me at <a href="mailto:christo@9592.tech">christo@9592.tech</a>
  </p>
</div>

<style>
  .blog-cta {
    background: var(--color-bg-secondary);
    border-radius: 10px;
    padding: 28px 28px 24px;
    margin-top: 48px;
  }

  .cta-headline {
    font-size: 19px;
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: 6px;
    letter-spacing: -0.01em;
  }

  .cta-description {
    color: var(--color-text-secondary);
    font-size: 14px;
    line-height: 1.55;
    margin-bottom: 20px;
  }

  .cta-form {
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  .cta-fields {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .form-field label {
    display: block;
    font-size: 12px;
    color: var(--color-text-secondary);
    margin-bottom: 5px;
    letter-spacing: 0.01em;
  }

  .form-field input {
    width: 100%;
    background: var(--color-bg-primary);
    border: 1px solid #2a2a2a;
    border-radius: 6px;
    padding: 10px 12px;
    color: var(--color-text-primary);
    font-size: 14px;
    font-family: inherit;
    transition: border-color 0.15s;
  }

  .form-field input:focus {
    outline: none;
    border-color: var(--color-accent);
  }

  .form-field input::placeholder {
    color: #4a4a4a;
  }

  .cta-submit {
    background: var(--color-accent);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 9px 18px;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.15s;
    align-self: flex-start;
  }

  .cta-submit:hover {
    background: var(--color-accent-hover);
  }

  .cta-submit:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .cta-fallback {
    margin-top: 20px;
    font-size: 13px;
    color: #555;
  }

  .cta-fallback a {
    color: var(--color-accent);
    text-decoration: none;
  }

  .cta-fallback a:hover {
    text-decoration: underline;
  }

  /* Success state */
  .cta-success {
    padding: 20px 0;
  }

  .success-message {
    color: #22c55e;
    font-size: 15px;
    font-weight: 500;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('blog-cta-form') as HTMLFormElement;
    const submitBtn = document.getElementById('cta-submit-btn') as HTMLButtonElement;
    const successDiv = document.getElementById('cta-success') as HTMLDivElement;
    const fallbackP = document.getElementById('cta-fallback') as HTMLParagraphElement;

    // Set context fields
    const pageTitle = document.title.replace(' | 9592 Solutions', '');
    (document.getElementById('cta-subject') as HTMLInputElement).value = `Blog inquiry: ${pageTitle}`;
    (document.getElementById('cta-from-page') as HTMLInputElement).value = pageTitle;
    (document.getElementById('cta-page-url') as HTMLInputElement).value = window.location.href;

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'Sending...';
      submitBtn.disabled = true;

      try {
        const formData = new FormData(form);
        const response = await fetch('https://api.web3forms.com/submit', {
          method: 'POST',
          body: formData
        });

        const result = await response.json();

        if (result.success) {
          // Show success, hide form
          form.style.display = 'none';
          fallbackP.style.display = 'none';
          successDiv.style.display = 'block';

          // TODO: Add Mixpanel event tracking here
          // mixpanel.track('Blog CTA Submit', { page: pageTitle });
        } else {
          throw new Error(result.message || 'Submission failed');
        }
      } catch (error) {
        console.error('Form submission error:', error);
        submitBtn.textContent = 'Error - try again';
        submitBtn.disabled = false;

        // Reset button text after 3 seconds
        setTimeout(() => {
          submitBtn.textContent = originalText;
        }, 3000);
      }
    });
  });
</script>
